#!/bin/bash

# libs
source /home/ckn/layersnap/params
source /home/ckn/layersnap/actions

# paths and vars
TargetName="$(basename $TargetPath)"
PoolPath="$(dirname $TargetPath)/.layersnap/$TargetName"
DateFormat="+%s" #"%Y-%m-%d_%H:%M"

#
# conntroller
#
# status, prepare, snapshot, merge or restore?
#

case $ACTION in

  # status
  status)
    ls_status
  ;;

  # prepare
  prepare)
    ls_prepare
  ;;
  
  # snapshot
  snapshot)
    # prepare target for snapshot first?
    if [ ! -d "$PoolPath" ]; then echo "### testdings"; fi
    echo "$PoolPath"
    if [ ! -d "$PoolPath" ]; then ls_prepare; fi
    ls_snapshot
  ;;
  
  #merge
  merge)
    if [ -d "$PoolPath" ]; then
      ls_merge
    else
      echo ERROR: $TargetPath is not layersnapped, so nothing to merge!
    fi
  ;;
  
  #restore
  restore)
    if [ -d "$PoolPath" ]; then
      ls_restore
    else
      echo ERROR: $TargetPath is not layersnapped, so nothing to restore!
    fi
  ;;
  
esac


# DIR=a; umount -R .layersnap/$DIR/*/merge; rm -R $DIR .layersnap/; mkdir $DIR; touch $DIR/f; layersnap -s $DIR

# umount -R .layersnap/$DIR/*/merge; rm -R $DIR .layersnap/;
# DIR=target; cp -R nextcloud/* $target; umount -R .layersnap/$DIR/*/merge; rm -R $DIR .layersnap/; mkdir $DIR; touch $DIR/f; layersnap -s $DIR; cp -R phpBB3/* $target;
