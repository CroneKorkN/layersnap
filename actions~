#!/bin/bash

# 
# show status and layers
#

ls_status() {
  setPoolVars

  echo "LAYERSNAP: $TargetPath" consists of $(expr $LayerCount + 1) layers and is $PoolMounted mounted.
  
  i=1; for f in "$PoolPath/lower-"*; do
    layerStatusLine $i $f
    i=$(expr $i + 1)
  done
  layerStatusLine $(expr $LayerCount + 1) $UpperPath upper
}

#
# mount pool
#

ls_mount() {
  setPoolVars
  
  # mount
  mount -t overlay overlay -olowerdir="$LowerList",upperdir="$UpperPath",workdir="$WorkPath" "$TargetPath"
}

#
# create new snapshot-layer
#
# - unmount layers, except for first snapshot 
# - make lower-layer from target- or form upper-directory (on first snapshot)
# - create new empty upper directory
# - remount layers
#

ls_snapshot() {
  setPoolVars
  
  if [ ! -d "$PoolPath" ]; then
    ls_snapshot_first
  else
    ls_snapshot_consecutive
  fi
  mkdir "$UpperPath"
  ls_mount
}

ls_snapshot_first() {
  mkdir -p "$PoolPath"
  mkdir "$WorkPath"
  mv    "$TargetPath" "$LowerPath"
  mkdir "$TargetPath"
}

ls_snapshot_consecutive() {
  umount "$TargetPath"
  mv "$UpperPath" "$LowerPath"
}

#
# restore layer
#
# - let user select layer-Id to restore
# - merge layer-after-layer into lowest layer
# - make lowest layer the new target dir
# - clean up
#

ls_restore() {
  ls_status
  read -p "Snapshot ID to restore: " LayerID

  umount "$TargetPath"
  rmdir  "$TargetPath"
    
  i=1
  for f in "$PoolPath/lower-"*; do
    # remember lowest layer and merge all upper layer into it
    if [ "$i" == 1 ]; then
      LowestPath="$f"
    else
      rsync --remove-source-files "$f/"* "$LowestPath"
    fi
    if [ "$i" == "$LayerID" ]; then
      break
    fi
    i=$(expr $i + 1)
  done
  
  mv "$LowestPath" "$TargetPath"
  rm -R "$PoolPath"
}


#
# merge layers
#

ls_merge() {
  ls_status
  
  read -p "Merge layers starting from: " fromLayerID
  read -p "Merge layers ending with: " toLayerID
  echo "All layers between and including layers $fromLayerID and $toLayerID will be merged into layer $toLayerID."
  read -p "Enter 'merge' to confirm: " confirmation
  if [ ! "$confirmation" == "merge" ]; then
    echo "aborting."
    #return 2
  fi
  
  # find toLayer-path
  i=1
  for f in "$PoolPath/lower-"*; do
    if [ "$i" == "$toLayerID" ]; then
      toLayerPath="$f"
      break
    fi
    i=$(expr $i + 1)
  done
  
  i=1
  for f in "$PoolPath/lower-"*; do
    echo $i $fromLayerID
    if [ "$i" -ge "$fromLayerID" ]; then
      if [ "$i" -lt "$toLayerID" ]; then
        echo "merging layer $i into layer $toLayerID"
        rsync --remove-source-files "$f/"* "$toLayerPath"
        rmdir "$f"
      fi
    fi
    i=$(expr $i + 1)
  done
}




















